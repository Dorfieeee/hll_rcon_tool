import React from "react";
import {
  handle_http_errors,
  postData,
  showResponse,
} from "../../utils/fetchUtils";
import InputLabel from "@material-ui/core/InputLabel";
import MenuItem from "@material-ui/core/MenuItem";
import FormControl from "@material-ui/core/FormControl";
import FormControlLabel from "@material-ui/core/FormControlLabel";
import Select from "@material-ui/core/Select";
import Grid from "@material-ui/core/Grid";
import { Button, IconButton, Switch } from "@material-ui/core";
import Autocomplete from "@material-ui/lab/Autocomplete";
import TextField from "@material-ui/core/TextField";
import RefreshIcon from "@material-ui/icons/Refresh";
import Paper from "@material-ui/core/Paper";
import moment from "moment";
import withWidth from "@material-ui/core/withWidth";
import AutoRefreshLine from "../autoRefreshLine";
import ListItemText from "@material-ui/core/ListItemText";
import FullscreenIcon from "@material-ui/icons/Fullscreen";
import FullscreenExitIcon from "@material-ui/icons/FullscreenExit";

const formatClass = (action, classes, highlightLogs) => {
  // if the message is a chat message
  if (highlightLogs) {
    if (action.toLowerCase().includes("chat")) {
      if (action.toLowerCase().includes("allies")) {
        return classes.logsChatAllies;
      }
      if (action.toLowerCase().includes("axis")) {
        return classes.logsChatAxis;
      }
    }
    else if (action.toLowerCase().includes("admin")) {
      return classes.logsAdmin;
    }
    else if (action.toLowerCase().includes("tk")) {
      return classes.logsTK;
    }
    else if (action.toLowerCase().includes("match")) {
      return classes.logsMatch;
    }
    else if (action.toLowerCase().includes("vote")) {
      return classes.logsVote;
    }
    else switch (action.toLowerCase()) {
      case "message":
        return classes.logsMessage;
      case "team kill":
        return classes.logsTeamKill;
      case "kill":
        return classes.logsKill;
      case "teamswitch":
        return classes.logsTeamSwitch;
      case "disconnected":
        return classes.logsDisconnected;
      case "connected":
        return classes.logsConnected;
    }
  }
  return classes.logs;
};

const Selector = ({
  classes,
  defaultValue,
  defaultText,
  values,
  currentValue,
  onChange,
  kind,
  multiple,
}) => (
  <FormControl className={classes.logsControl}>
    <InputLabel shrink>{kind}</InputLabel>
    <Select
      value={currentValue}
      onChange={(e) => onChange(e.target.value)}
      displayEmpty
      multiple={multiple}
    >
      {defaultValue !== undefined ? (
        <MenuItem value={defaultValue}>
          <em>{defaultText}</em>
        </MenuItem>
      ) : (
        ""
      )}
      {values.map((a) => (
        <MenuItem key={a} value={a}>
          {a}
        </MenuItem>
      ))}
    </Select>
  </FormControl>
);

class Logs extends React.Component {
  constructor(props) {
    super(props);
    console.log(
      "logs_action_type",
      JSON.parse(localStorage.getItem("logs_action_type"))
    );
    this.state = {
      logs: [],
      actions: [],
      players: [],
      playersFilter: localStorage.getItem("logs_player_filters")
        ? JSON.parse(localStorage.getItem("logs_player_filters"))
        : [],
      actionsFilter: localStorage.getItem("logs_action_filters")
        ? JSON.parse(localStorage.getItem("logs_action_filters"))
        : [],
      inclusiveFilter:
        localStorage.getItem("logs_action_type") !== null
          ? JSON.parse(localStorage.getItem("logs_action_type"))
          : true,
      limit: localStorage.getItem("logs_limit")
        ? localStorage.getItem("logs_limit")
        : 500,
      limitOptions: [
        100, 250, 500, 1000, 2500, 5000, 10000, 25000, 50000, 100000,
      ],
      highlightLogs: localStorage.getItem("logs_highlight_logs")
        ? localStorage.getItem("logs_highlight_logs") === 'true'
        : false,
    };

    this.loadLogs = this.loadLogs.bind(this);
    this.setActionFilter = this.setActionFilter.bind(this);
    this.setActionsFilterInclusivity =
      this.setActionsFilterInclusivity.bind(this);
    this.setLimit = this.setLimit.bind(this);
    this.setHighlightLogs = this.setHighlightLogs.bind(this);
  }

  componentDidMount() {
    setTimeout(() => {
      this.loadLogs();
    }, 1000);
  }

  loadLogs() {
    const { actionsFilter, playersFilter, limit, inclusiveFilter } = this.state;

    return postData(`${process.env.REACT_APP_API_URL}get_recent_logs`, {
      end: limit,
      filter_action: actionsFilter,
      filter_player: playersFilter,
      inclusive_filter: inclusiveFilter,
    })
      .then((response) => showResponse(response, "get_logs"))
      .then((data) => {
        this.setState({
          logs: data.result.logs,
          actions: data.result.actions,
          players: !data.result.players ? [] : data.result.players,
        });
      })
      .catch(handle_http_errors);
  }

  setActionFilter(actionsFilter) {
    this.setState({ actionsFilter }, this.loadLogs);
    localStorage.setItem("logs_action_filters", JSON.stringify(actionsFilter));
  }

  setActionsFilterInclusivity(e) {
    this.setState({ inclusiveFilter: e.target.value }, this.loadLogs);
    localStorage.setItem("logs_action_type", JSON.stringify(e.target.value));
  }

  setLimit(limit) {
    this.setState({ limit }, this.loadLogs);
    localStorage.setItem("logs_limit", limit);
  }

  setHighlightLogs(highlightLogs) {
    this.setState({ highlightLogs });
    localStorage.setItem("logs_highlight_logs", highlightLogs);
  }

  render() {
    const { classes, isFullScreen, onFullScreen } = this.props;
    const {
      logs,
      players,
      actions,
      actionsFilter,
      limit,
      limitOptions,
      inclusiveFilter,
      playersFilter,
      highlightLogs,
    } = this.state;

    return (
      <React.Fragment>
        <Grid container justify="flex-start">
          <Grid
            item
            xs={12}
            className={`${classes.textLeft} ${classes.paddingLeft}`}
          >
            <h1 className={classes.marginBottom}>
              Logs view{" "}
              <IconButton onClick={onFullScreen}>
                {isFullScreen ? <FullscreenExitIcon /> : <FullscreenIcon />}
              </IconButton>
              <FormControlLabel
                control={
                  <Switch
                    checked={highlightLogs}
                    onChange={(e) => this.setHighlightLogs(e.target.checked)}
                    color="primary"
                  />
                }
                label="Highlight Logs"
                labelPlacement="top"
              />
            </h1>
            <ListItemText secondary="10s auto refresh" />
            <AutoRefreshLine
              className={classes.marginTop}
              intervalFunction={this.loadLogs}
              execEveryMs={10000}
              statusRefreshIntervalMs={250}
              classes={classes}
            />
          </Grid>
        </Grid>
        <Grid container justify="space-around" className={classes.marginBottom}>
          <Grid className={classes.padding} item xs={12} sm={12} md={12} lg={2}>
            <Selector
              classes={classes}
              values={limitOptions}
              onChange={this.setLimit}
              currentValue={limit}
              kind="Show last N lines"
            />
          </Grid>
          <Grid className={classes.padding} item xs={12} sm={12} md={12} lg={2}>
            <FormControl fullWidth>
              <InputLabel shrink>Inclusive/Exclusive</InputLabel>
              <Select
                onChange={this.setActionsFilterInclusivity}
                value={inclusiveFilter}
                defaultValue={true}
              >
                <MenuItem value={true}>Inclusive</MenuItem>
                <MenuItem value={false}>Exclusive</MenuItem>
              </Select>
            </FormControl>
          </Grid>
          <Grid className={classes.padding} item xs={12} sm={12} md={12} lg={3}>
            <Autocomplete
              id="tags-outlined"
              multiple
              options={actions}
              value={actionsFilter}
              getOptionLabel={(option) => option}
              filterSelectedOptions
              onChange={(e, value) => this.setActionFilter(value)}
              renderInput={(params) => (
                <TextField
                  className={classes.logsControl}
                  {...params}
                  variant="outlined"
                  label="Filter by type"
                />
              )}
            />
          </Grid>
          <Grid className={classes.padding} item xs={12} sm={12} md={12} lg={4}>
            <Autocomplete
              id="tags-outlined"
              multiple
              options={players.sort()}
              value={playersFilter}
              getOptionLabel={(option) => option}
              filterSelectedOptions
              onChange={(e, value) => {
                this.setState(
                  { playersFilter: value ? value : "" },
                  this.loadLogs
                );
                if (value) {
                  localStorage.setItem(
                    "logs_player_filters",
                    JSON.stringify(value)
                  );
                }
              }}
              renderInput={(params) => (
                <TextField
                  className={classes.logsControl}
                  {...params}
                  variant="outlined"
                  label="Filter by player"
                />
              )}
            />
          </Grid>
          <Grid className={classes.padding} item xs={12} sm={12} md={12} lg={1}>
            <Button
              className={classes.logsControl}
              disableElevation
              size="large"
              variant="outlined"
              onClick={this.loadLogs}
            >
              <RefreshIcon />
            </Button>
          </Grid>
        </Grid>
        <Grid container justify="center" alignItems="center">
          <Grid item className={classes.padding} xs={12}>
            <Paper className={classes.paperLogs}>
              {logs.map((l) => (
                <pre key={l.raw} className={formatClass(l.action, classes, highlightLogs)}>
                {moment(new Date(l.timestamp_ms)).format("HH:mm:ss") +
                  " " +
                  l.action.replace(
                    /(ADMIN ANTI-CHEAT)/, 'üö∑CHEAT').replace(
                    /(ADMIN BANNED)/, '‚åõTEMPBAN').replace(
                    /(ADMIN IDLE)/, 'üí§IDLE').replace(
                    /(ADMIN KICKED)/, 'üö∑KICK').replace(
                    /(ADMIN MISC)/, 'üö®MISC').replace(
                    /(ADMIN PERMA BANNED)/, '‚õîPERMBAN').replace(
                    /(ADMIN)$/, 'üö®ADMIN').replace(
                    /(CAMERA)/, 'üëÄCAM').replace(
                    /(CHAT\[Allies\]\[Team\])/, 'üü¶CHAT').replace(
                    /(CHAT\[Axis\]\[Team\])/, 'üü•CHAT').replace(
                    /(CHAT\[Allies\]\[Unit\])/, 'üü¶CHAT[u]').replace(
                    /(CHAT\[Axis\]\[Unit\])/, 'üü•CHAT[u]').replace(
                    /^(CONNECTED)/, 'üõ¨ARRIVAL').replace(
                    /(DISCONNECTED)/, 'üõ´DEPART').replace(
                    /^(KILL)/, 'üíÄKILL').replace(
                    /(MATCH ENDED)/, 'üèÅEND').replace(
                    /(MATCH START)/, 'üèÅSTART').replace(
                    /(MESSAGE)/, 'üì¢MESSAGE').replace(
                    /(TEAM KILL)/, '‚ö†Ô∏èTK').replace(
                    /(TEAMSWITCH)/, '‚ôªÔ∏èSWITCH').replace(
                    /(TK AUTO KICKED)/, 'üö∑KICK TK').replace(
                    /(VOTE COMPLETED)/, 'üôãEND').replace(
                    /(VOTE EXPIRED)/, 'üôãEXPIRED').replace(
                    /(VOTE PASSED)/, 'üôãPASSED').replace(
                    /(VOTE STARTED)/, 'üôãSTART').replace(
                    /(VOTE)$/, 'üôãVOTE').padEnd(9) +
                    " | " +
                  l.message.replace(
                    // general space formatting
                    /\n{1,}/g, ' ').replace(
                    /\s{2,}/g, ' ').replace(
                    // ADMIN ANTI-CHEAT
                    /^KICK: \[(.*)\] has been kicked. \[Anti-Cheat (.*)\]/, '$1 ($2)').replace(
                    // ADMIN BANNED
                    /^KICK: \[(.*)\] has been kicked. \[BANNED FOR (.*) BY THE ADMINISTRATOR! /, '$1 ($2)').replace(
                    // ADMIN IDLE
                    /^KICK: \[(.*)\] has been kicked. \[YOU WERE KICKED FOR BEING IDLE\]$/, '$1 (idle)').replace(
                    /^KICK: \[(.*)\] has been kicked. \[YOU WERE KICKED DUE TO HIGH PING\]$/, '$1 (high ping)').replace(
                    // ADMIN KICKED
                    /^KICK: \[(.*)\] has been kicked. \[KICKED BY THE ADMINISTRATOR! (.*)\]/, '$1 üì¢$2').replace(
                    // ADMIN MISC
                    /^KICK: \[(.*)\] has been kicked. \[Kicked for (.*)\]/, '$1 ($2)').replace(
                    // ADMIN PERMA BANNED
                    /^(KICK|BAN): \[(.*)\] has been (kicked|banned). \[PERMANENTLY BANNED BY THE ADMINISTRATOR! (.*)\]/, '$2 üì¢$4').replace(
                    // CAMERA
                    /^\[(.*) \(([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}|\d{17})\)\] (Entered|Left) Admin Camera$/, '$1 ($3)').replace(
                    // CHAT
                    /^(.*?): (.*) \(([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}|\d{17})\)$/, '$1 üí¨$2').replace(
                    // CONNECTED / DISCONNECTED
                    /^(.*?) \(([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}|\d{17})\)$/, '$1').replace(
                    // KILL, TEAMKILL
                    /^(.*)\(Allies\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}|\d{17})\) -> /, 'üü¶$1 -> ').replace(
                    /^(.*)\(Axis\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}|\d{17})\) -> /, 'üü•$1 -> ').replace(
                    / -> (.*)\(Allies\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}|\d{17})\) with /, ' -> üü¶$1 \/ ').replace(
                    / -> (.*)\(Axis\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}|\d{17})\) with /, ' -> üü•$1 \/ ').replace(
                    // KILL, TEAMKILL / highlight suspicious teamkills
                    / (M1918A2 BAR|STG44|FG42|Bren Gun)$/, ' ‚ö†Ô∏è$1‚ö†Ô∏è').replace(
                    / (KARABINER 98K|MOSIN NAGANT 1891|MOSIN NAGANT 91\/30|MOSIN NAGANT M38|SMLE No.1 Mk III|Rifle No.4 Mk I|Rifle No.5 Mk I)$/, ' ‚ö†Ô∏è$1‚ö†Ô∏è').replace(
                    / (M3 KNIFE|FELDSPATEN|MPL-50 SPADE|Fairbairn‚ÄìSykes)$/, ' ‚ö†Ô∏è‚ö†Ô∏è$1‚ö†Ô∏è‚ö†Ô∏è').replace(
                    / (COLT M1911|WALTHER P38|LUGER P08|NAGANT M1895|TOKAREV TT33|Webley MK VI)$/, ' ‚ö†Ô∏è$1‚ö†Ô∏è').replace(
                    / (M1 GARAND|M1 CARBINE|GEWEHR 43|SVT40)$/, ' ‚ö†Ô∏è$1‚ö†Ô∏è').replace(
                    / (M97 TRENCH GUN)$/, ' ‚ö†Ô∏è$1‚ö†Ô∏è').replace(
                    / (M1903 SPRINGFIELD|M1919 SPRINGFIELD|KARABINER 98K x8|FG42 x4|SCOPED MOSIN NAGANT 91\/30|SCOPED SVT40|Lee-Enfield Pattern 1914 Sniper)$/, ' ‚ö†Ô∏è$1‚ö†Ô∏è').replace(
                    / (M1A1 THOMPSON|M3 GREASE GUN|MP40|PPSH 41|PPSH 41 W\/DRUM|Sten Gun|Lanchester|M1928A1 THOMPSON)$/, ' ‚ö†Ô∏è$1‚ö†Ô∏è').replace(
                    // MESSAGE
                    /^(.*)\((([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})|(\d{17}))\): (.*)$/, '$1 üì¢$5').replace(
                    // TEAMSWITCH
                    /^TEAMSWITCH /, '').replace(
                    /\(None > Allies\)/, '->üü¶').replace(
                    /\(None > Axis\)/, '->üü•').replace(
                    /\(Allies > Axis\)/, 'üü¶->üü•').replace(
                    /\(Axis > Allies\)/, 'üü•->üü¶').replace(
                    // VOTEMAP
                    /üí¨(!vm|!votemap)/i, 'üôã‚Äç‚ôÇÔ∏è').replace(
                    // general space formatting
                    /(.{70})(?=.)/g,'$1\n                      ').replace(
                    / {23,}/g,'                      ').replace(
                    // MATCH (must come after general space formatting)
                    /^MATCH START (.*)/, 'üü¢$1\n                     ----------------------------------------------------------------------').replace(
                    /^MATCH ENDED (.*)/, '----------------------------------------------------------------------\n                     üî¥$1').replace(
                    /`/g, '').replace(
                    /ALLIED \(([0-5]) - ([0-5])\) AXIS/, 'üü¶$1-$2üü•')}
              </pre>
              ))}
            </Paper>
          </Grid>
        </Grid>
      </React.Fragment>
    );
  }
}

export default withWidth()(Logs);
